
<div ng-controller="GroupCtrl">


    <div>
        <button ng-show="editFilter" ng-click="createGroupScheduleModal()" type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalLong">新增</button>
        <button type="button" class="btn btn-primary" ng-click="ganttStartMonth.subtract(1, 'y'); UpdateAllPlots()"><<</button>
        <button type="button" class="btn btn-primary" ng-click="ganttStartMonth.subtract(1, 'M'); UpdateAllPlots()"><</button>
        <button type="button" class="btn btn-primary" ng-click="ganttStartMonth.add(1, 'M'); UpdateAllPlots()">></button>
        <button type="button" class="btn btn-primary" ng-click="ganttStartMonth.add(1, 'y'); UpdateAllPlots()">>></button>
        <p ng-bind="ganttStartMonth.local('zh-tw').format('YYYY-MM')"></p>
    </div>

    <div class="chartmenu mb-5">
        <div>
            <label for="SelectGroup">請選擇組別</label>
            <select class="form-select" id="SelectGroup" name="SelectGroup" ng-model="selectedGroup" ng-change="filterMembers()" aria-label="Select the Group">
                <option ng-repeat="group in auth.GroupAuthorities" value="{{group.GroupName}}">{{group.GroupName}}</option>
            </select>
        </div>
    </div>


    <table class="table">
        <thead class="thead-dark">
            <tr>
                <th scope="col">#</th>
                <th scope="col">計畫編號</th>
                <th scope="col">工作項目</th>
                <th scope="col">主要人員/使用人時</th>               
                <th scope="col">Chart</th>
                <th scope="col">本月累計進度(%)</th>
                <th scope="col">上月累計進度(%)</th>
                <th scope="col">當月人時</th>
                <th scope="col">總人時</th>
            </tr>
        </thead>

        <tbody ng-repeat="groupSchedule in data">
            <tr ng-show="scheduleFilter(groupSchedule.Group)">
                <td>
                    <button ng-show="editFilter" ng-click="createDetailScheduleModal(groupSchedule.Group)" type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalLong">
                        新增細項
                    </button>

                    <button ng-show="editFilter" ng-click="cloneDeepToModal(groupSchedule.Group, $index); passChosen()" type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalLong">
                        編輯
                    </button>
                </td>
                <td ng-bind="groupSchedule.Group.projno"></td>
                <td ng-bind="groupSchedule.Group.content"></td>
                <td ng-bind="groupSchedule.Group.memberHours"></td>
                <td>
                    <svg id="svg{{$index}}" width="800" , height="80"></svg>
                </td>                
                <td ng-bind="groupSchedule.Group.percent_complete"></td>
                <td ng-bind="groupSchedule.Group.last_percent_complete"></td>
                <td ng-bind="groupSchedule.Group.monthlyHours"></td>
                <td ng-bind="groupSchedule.Group.totalHours"></td>
            </tr>
            <tr ng-show="scheduleFilter(groupSchedule.Group)">
                <td colspan="8">
                    <table class="table mb-0">
                        <tbody ng-repeat="detailSchedule in groupSchedule.Details">
                            <tr>
                                <td>
                                    @*<button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseExample{{$parent.$index}}-{{$index}}" aria-expanded="false" aria-controls="collapseExample">
                                        展開
                                    </button>*@

                                    <button ng-show="editFilter" ng-click="cloneDeepToModal(detailSchedule.Detail, $index); passChosen()" type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalLong">
                                        編輯
                                    </button>
                                </td>

                                <td ng-bind="detailSchedule.Detail.projno"></td>
                                <td ng-bind="detailSchedule.Detail.content"></td>
                                <td>
                                    <svg id="svgChild{{$parent.$index}}-{{$index}}" width="800" , height="80"></svg>
                                </td>                                
                                <td ng-bind="detailSchedule.Detail.percent_complete"></td>
                                <td ng-bind="detailSchedule.Detail.last_percent_complete"></td>
                            </tr>
                            <tr>
                                <td>
                                </td>
                                <td colspan="3">
                                    <div class="collapse" id="collapseExample{{$parent.$index}}-{{$index}}">
                                        <table class="table mb-0">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th scope="col">內容</th>
                                                    <th scope="col">日期</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="milestone in oschedule.milestones">
                                                    <td ng-bind="milestone.content"></td>
                                                    <td ng-bind="milestone.date"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>

                            </tr>
                        </tbody>
                    </table>

                </td>
            </tr>
        </tbody>
    </table>


    <!-- Modal -->
    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">編輯項目</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">計畫編號</span>
                        </div>
                        <input ng-disabled="modal.type !== 1" ng-model="modal.projno" type="text" class="form-control" placeholder="請輸入計畫編號" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">工作項目</span>
                        </div>
                        <input ng-model="modal.content" type="text" class="form-control" placeholder="請輸入工作項目" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                    <!-- member selection -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">主要人員</span>
                        </div>
                        <div ng-dropdown-multiselect="" options="filteredMembers" events="yourEvents" selected-model="multiselectedmodel"></div>
                    </div>
                    @*<div ng-dropdown-multiselect="" options="filteredMembers" events="yourEvents" selected-model="multiselectedmodel"></div>*@
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">本月累計進度(%)</span>
                        </div>
                        <input ng-model="modal.percent_complete" type="text" class="form-control" placeholder="請輸入本月進度(%)" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">上月累計進度(%)</span>
                        </div>
                        <input ng-model="modal.last_percent_complete" type="text" class="form-control" placeholder="請輸入上月進度(%)" aria-label="Username" aria-describedby="basic-addon1">
                    </div>



                    <div class="input-group mb-3"
                         moment-picker="modal.start_date"
                         format="YYYY-MM-DD"
                         locale="zh-tw">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">開始日期</span>
                            <span class="input-group-text material-icons" id="basic-addon1">calendar_month</span>
                        </div>
                        @*<div class="input-group-prepend">
                <span class="input-group-text material-icons" id="basic-addon1">calendar_month</span>
            </div>*@
                        <input class="form-control"
                               placeholder="請選擇日期"
                               ng-model="modal.start_date"
                               ng-model-options="{ updateOn: 'blur' }">
                    </div>
                    <div class="input-group mb-3"
                         moment-picker="modal.end_date"
                         format="YYYY-MM-DD"
                         locale="zh-tw">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">結束日期</span>
                            <span class="input-group-text material-icons" id="basic-addon1">calendar_month</span>
                        </div>
                        <input class="form-control"
                               placeholder="請選擇日期"
                               ng-model="modal.end_date"
                               ng-model-options="{ updateOn: 'blur' }">

                    </div>
                    <button ng-click="addMilestone()" type="button" class="btn btn-primary mb-3">
                        新增里程碑
                    </button>

                    <div ng-repeat="milestone in modal.milestones" class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">工作內容</span>
                        </div>
                        <input ng-model="milestone.content" type="text" class="form-control" placeholder="工作內容" aria-label="Username" aria-describedby="basic-addon1">
                        <div class="input-group-prepend"
                             moment-picker="milestone.date"
                             format="YYYY-MM-DD"
                             locale="zh-tw">
                            <div class="input-group-prepend">
                                <span class="input-group-text material-icons" id="basic-addon1">calendar_month</span>
                            </div>
                            <input class="form-control"
                                   placeholder="請選擇年月份"
                                   ng-model="milestone.date"
                                   ng-model-options="{ updateOn: 'blur' }">
                        </div>
                        <div class=" input-group-prepend">
                            <button type="button" class="btn btn-primary" name="removeMilestone" ng-click="removeMilestone($index)">
                                刪除里程碑
                            </button>
                        </div>                        
                    </div>

                </div>
                <div class="modal-footer d-flex justify-content-around">
                    <button type="button" class="btn btn-outline-danger" data-dismiss="modal" ng-if="modal.createMode">取消</button>
                    <button type="button" class="btn btn-outline-danger" data-toggle="modal" ng-if="!modal.createMode" data-target="#alertModalCenter">刪除</button>
                    <button type="button" class="btn btn-outline-success" data-dismiss="modal" ng-if="modal.createMode" ng-click="createSchedule()">建立</button>
                    <button type="button" class="btn btn-outline-success" data-dismiss="modal" ng-if="!modal.createMode" ng-click="updateSchedule()">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal fade" id="alertModalCenter" tabindex="-1" role="dialog" aria-labelledby="alertModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalCenterTitle">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-outline-danger" data-dismiss="modal" ng-click="deleteSchedule()">確定</button>
                </div>
            </div>
        </div>
    </div>



</div>



