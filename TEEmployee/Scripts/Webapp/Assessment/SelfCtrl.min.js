var app=angular.module("app",["ngAnimate"]);app.run(["$http","$window",function(n){n.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";n.defaults.headers.common.__RequestVerificationToken=$("input[name=__RequestVerificationToken]").val()}]);app.service("appService",["$http",function(n){this.GetAllSelfAssessments=function(t){return n.post("Assessment/GetAllSelfAssessments",t)};this.CreateResponse=function(t){return n.post("Assessment/CreateResponse",t)};this.GetResponse=function(t){return n.post("Assessment/GetResponse",t)};this.GetResponseByYear=function(t){return n.post("Assessment/GetResponseByYear",t)};this.GetYearList=function(t){return n.post("Assessment/GetYearList",t)};this.GetAllFeedbacks=function(t){return n.post("Assessment/GetAllFeedbacks",t)}}]);app.controller("SelfCtrl",["$scope","$window","appService","$rootScope","$timeout",function(n,t,i,r,u){function o({target:n}){n.classList.contains("autoExpand")&&!0&&(n.style.height="",n.style.height=Math.min(n.scrollHeight,f)+"px")}n.SelfAssessments=[];n.state;const e=["優良","好","普通","待加強","N/A"],f=250;n.data={model:null,availableOptions:[]};n.myFunction=function(n){alert(n)};i.GetYearList({}).then(function(t){n.years=t;t.data.forEach(function(t){n.data.availableOptions.push({id:t,name:t})});n.data.model=n.data.availableOptions[0].name});n.Response=[];n.finished=()=>{u(function(){if(n.state==="save"){const n=document.querySelectorAll(".autoExpand");for(let n of n)n.style.height="",n.style.height=Math.min(n.scrollHeight,f)+"px"}},0)};n.CreateResponse=function(r){i.CreateResponse({assessments:n.SelfAssessments,state:r,year:n.data.model}).then(function(){r==="save"?(n.succeed=!0,u(function(){n.succeed=!1},2e3)):t.location.href="Assessment"})};n.GetResponseByYear=function(t){i.GetResponseByYear({year:t}).then(function(r){if(n.state=r.data.State,r.data.Responses.length!==0){if(n.state==="submit")for(let n=0;n!==r.data.Responses.length;n++)r.data.Responses[n].Choice.includes("option")&&(r.data.Responses[n].Choice=e[Number(r.data.Responses[n].Choice.slice(6))-1]);var u=[],f=Math.max(...r.data.Responses.map(n=>Number(n.CategoryId)));i.GetAllFeedbacks({year:t}).then(function(t){for(var h,i,s,e,o=0;o<f+1;o++){for(h=[],i=0;i<t.data.length;i++)t.data[i].Text[o]!==""&&h.push({Name:t.data[i].Name,Text:t.data[i].Text[o]});u.push(h)}for(s=0,e=0;e<r.data.Responses.length;e++)r.data.Responses[e].Content==="自評摘要"&&(u[s].forEach(function(n){r.data.Responses.splice(e+1,0,{CategoryId:r.data.Responses[e].CategoryId,Content:"意見回饋",Choice:n.Text,Name:n.Name})}),s++);n.SelfAssessments=r.data.Responses;n.finished();n.Feedbacks=u[s]})}else i.GetAllSelfAssessments({}).then(function(t){n.SelfAssessments=t.data}).catch(function(){alert("Error")})}).catch(function(){alert("Error")})};n.GetResponseByYear();document.addEventListener("input",o)}]);