var app=angular.module("app",["moment-picker","ngAnimate"]);app.run(["$http","$window",function(n){n.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";n.defaults.headers.common.__RequestVerificationToken=$("input[name=__RequestVerificationToken]").val()}]);app.service("appService",["$http",function(n){this.GetAllMonthlyRecordData=t=>n.post("Tasklog/GetAllMonthlyRecordData",t);this.UpdateProjectTask=t=>n.post("Tasklog/UpdateProjectTask",t);this.GetTasklogData=t=>n.post("Tasklog/GetTasklogData",t);this.DeleteProjectTask=t=>n.post("Tasklog/DeleteProjectTask",t);this.GetTasklogDataByGuid=t=>n.post("Tasklog/GetTasklogDataByGuid",t);this.GetUserByGuid=t=>n.post("Tasklog/GetUserByGuid",t)}]);app.controller("ListCtrl",["$scope","$window","appService","$rootScope","$q",function(n,t,i){n.months=["01","02","03","04","05","06","07","08","09","10","11","12"];n.years=[];const r=new Date,[u,f]=[r.getMonth(),r.getFullYear()];for(let t=f;t!==2019;t--)n.years.push(t.toString());n.selectedYear=n.years[0];n.selectedMonth=n.months[u];n.data=[];n.ctrl={};n.ctrl.datepicker=moment().add(-1,"months").locale("zh-tw").format("YYYY-MM");n.propertyName="User.group_one";n.reverse=!0;n.sortBy=function(t){n.reverse=n.propertyName===t?!n.reverse:!1;n.propertyName=t};n.GetAllMonthlyRecordData=()=>{let t=`${Number(n.ctrl.datepicker.slice(0,4))-1911}${n.ctrl.datepicker.slice(5,7)}`;i.GetAllMonthlyRecordData({yymm:t}).then(t=>{n.data=t.data})};n.GetAllMonthlyRecordData()}]);app.controller("DetailsCtrl",["$scope","$window","appService","$rootScope","$q",function(n,t,i){i.GetUserByGuid({guid:t.guid}).then(t=>{n.user=t.data,document.title=n.user.name+"-工作紀錄管控表"});i.GetTasklogDataByGuid({guid:t.guid}).then(t=>{n.projects=[];const i=t.data.ProjectItems,r=t.data.ProjectTasks;for(let t of r)if(!(i.findIndex(n=>n.projno===t.projno)<0)){let r=n.projects.findIndex(n=>n.projno===t.projno);r<0&&(n.projects.push({logs:[],projno:t.projno,realHour:t.realHour}),r=n.projects.length-1);n.projects[r].logs.push({id:t.id,content:t.content,endDate:t.endDate,note:t.note})}for(let t of i){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[{}],projno:t.projno}),i=n.projects.length-1);n.projects[i].itemno?(n.projects[i].itemno+=`${t.itemno}, `,n.projects[i].workHour+=t.workHour,n.projects[i].overtime+=t.overtime):(n.projects[i].itemno=`${t.itemno}, `,n.projects[i].workHour=t.workHour,n.projects[i].overtime=t.overtime)}for(let t=0;t<n.projects.length;t++)(n.projects[t].workHour||n.projects[t].overtime)&&(n.projects[t].hourStr=n.projects[t].workHour.toString()+" + "+n.projects[t].overtime.toString()),n.projects[t].itemno&&(n.projects[t].itemno=n.projects[t].itemno.slice(0,n.projects[t].itemno.length-2))})}]);app.controller("EditCtrl",["$scope","$window","appService","$rootScope","$q","$timeout",function(n,t,i,r,u,f){function c({target:n}){n.classList.contains("autoExpand")&&!0&&(n.style.height="",n.style.height=Math.min(n.scrollHeight,o)+"px")}n.months=["01","02","03","04","05","06","07","08","09","10","11","12"];n.years=[];n.ctrl={};n.ctrl.datepicker=moment().locale("zh-tw").format("YYYY-MM");const e=new Date,[s,h]=[e.getMonth(),e.getFullYear()];var o=250;for(let t=h;t!==2019;t--)n.years.push(t.toString());n.selectedYear=n.years[0];n.selectedMonth=n.months[s];n.data=[];n.deletedIds=[];n.projects=[{logs:[{}]}];n.addLogRow=t=>{n.projects[t].logs.splice(n.projects[t].logs.length,0,{})};n.removeLogRow=(t,i)=>{if(n.projects[t].itemno!==undefined&&n.projects[t].logs.length===1)n.projects[t].logs[i].content="",n.projects[t].logs[i].endDate="",n.projects[t].logs[i].note="";else{let r=n.projects[t].logs[i].id;r&&n.deletedIds.push(r);n.projects[t].logs.splice(i,1)}};n.addProjRow=()=>{n.projects.push({logs:[{}]})};n.UpdateTasklogData=()=>{let t=[],o=`${Number(n.ctrl.datepicker.slice(0,4))-1911}${n.ctrl.datepicker.slice(5,7)}`;for(let n of n.projects)for(let i of n.logs)t.push({id:i.id,yymm:o,projno:n.projno,realHour:n.realHour,content:i.content,endDate:i.endDate,note:i.note});let r=Promise.resolve("a"),e=Promise.resolve("b");n.deletedIds.length!==0&&(r=i.DeleteProjectTask(n.deletedIds).then(()=>{}).catch(()=>{alert("Error")}));t.length!==0&&(e=i.UpdateProjectTask(t).then(()=>{}).catch(()=>{alert("Error")}));u.all([r,e]).then(()=>{n.GetTasklogData(),n.succeed=!0,f(function(){n.succeed=!1},2e3)})};n.GetTasklogData=()=>{let t=`${Number(n.ctrl.datepicker.slice(0,4))-1911}${n.ctrl.datepicker.slice(5,7)}`;i.GetTasklogData({yymm:t}).then(t=>{n.projects=[];const i=t.data.ProjectItems,r=t.data.ProjectTasks;for(let t of r){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[],projno:t.projno,realHour:t.realHour}),i=n.projects.length-1);n.projects[i].logs.push({id:t.id,content:t.content,endDate:t.endDate,note:t.note})}for(let t of i){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[{}],projno:t.projno}),i=n.projects.length-1);n.projects[i].itemno?(n.projects[i].itemno+=`${t.itemno}, `,n.projects[i].workHour+=t.workHour,n.projects[i].overtime+=t.overtime):(n.projects[i].itemno=`${t.itemno}, `,n.projects[i].workHour=t.workHour,n.projects[i].overtime=t.overtime)}for(let t=0;t<n.projects.length;t++)(n.projects[t].workHour||n.projects[t].overtime)&&(n.projects[t].hourStr=n.projects[t].workHour.toString()+" + "+n.projects[t].overtime.toString(),n.projects[t].realHour||(n.projects[t].realHour=n.projects[t].workHour+n.projects[t].overtime)),n.projects[t].itemno&&(n.projects[t].itemno=n.projects[t].itemno.slice(0,n.projects[t].itemno.length-2));n.projects.length===0&&n.projects.push({logs:[{}]});f(function(){const n=document.querySelectorAll(".autoExpand");for(let n of n)n.style.height="",n.style.height=Math.min(n.scrollHeight,o)+"px"},0)})};n.GetTasklogData();document.addEventListener("input",c)}]);