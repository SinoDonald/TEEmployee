var app=angular.module("app",["moment-picker","ui.router","ngAnimate"]);app.config(["$stateProvider","$urlRouterProvider",function(n){n.state("UserList",{url:"/UserList",templateUrl:"Tasklog/UserList"}).state("UsersDetails",{url:"/UsersDetails",templateUrl:"Tasklog/UsersDetails"})}]);app.run(["$http","$window",function(n){n.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";n.defaults.headers.common.__RequestVerificationToken=$("input[name=__RequestVerificationToken]").val()}]);app.service("appService",["$http",function(n){this.GetAllMonthlyRecordData=t=>n.post("Tasklog/GetAllMonthlyRecordData",t);this.UpdateProjectTask=t=>n.post("Tasklog/UpdateProjectTask",t);this.GetTasklogData=t=>n.post("Tasklog/GetTasklogData",t);this.DeleteProjectTask=t=>n.post("Tasklog/DeleteProjectTask",t);this.GetTasklogDataByGuid=t=>n.post("Tasklog/GetTasklogDataByGuid",t);this.GetUserByGuid=t=>n.post("Tasklog/GetUserByGuid",t);this.GetLastMonthData=t=>n.post("Tasklog/GetLastMonthData",t);this.GetMemberContent=t=>n.post("Tasklog/GetMemberContent",t)}]);app.factory("myFactory",function(){function t(t,i){n.users=t;n.monthlyRecord=i}function i(){return n}var n={};return{set:t,get:i}});app.controller("ListCtrl",["$scope","$window","appService","$rootScope","$location",function(n,t,i,r,u){u.path("/UserList")}]);app.controller("UserListCtrl",["$scope","$location","$window","appService","$rootScope","$q","myFactory",function(n,t,i,r,u,f,e){n.months=["01","02","03","04","05","06","07","08","09","10","11","12"];n.years=[];const o=new Date,[s,h]=[o.getMonth(),o.getFullYear()];for(let t=h;t!==2019;t--)n.years.push(t.toString());n.selectedYear=n.years[0];n.selectedMonth=n.months[s];n.data=[];n.ctrl={};n.ctrl.datepicker=moment().add(-1,"months").locale("zh-tw").format("YYYY-MM");n.propertyName="User.group_one";n.reverse=!1;n.sortBy=function(t){n.reverse=n.propertyName===t?!n.reverse:!1;n.propertyName=t};n.GetAllMonthlyRecordData=()=>{let t=`${Number(n.ctrl.datepicker.slice(0,4))-1911}${n.ctrl.datepicker.slice(5,7)}`;r.GetAllMonthlyRecordData({yymm:t}).then(t=>{n.data=t.data})};n.GetAllMonthlyRecordData();n.GetMemberContent=function(){let i=n.data.filter(n=>n.selected===!0),u=[],r=[];for(let n=0;n<i.length;n++)u.push(i[n].MonthlyRecord),r.push(i[n].User);e.set(r,i[0].MonthlyRecord.yymm);t.path("/UsersDetails")}}]);app.controller("UsersDetailsCtrl",["$scope","$window","appService","$rootScope","myFactory",function(n,t,i,r,u){n.monthlyRecord=u.get().monthlyRecord;n.users=u.get().users;i.GetMemberContent({yymm:n.monthlyRecord,users:n.users}).then(function(t){n.yymm=t.data[0].yymm;n.projectList=[];for(let t of t.data){n.projects=[];n.projects.user=t.User;n.projects.yymm=t.yymm;const i=t.ProjectItems,r=t.ProjectTasks;for(let i of r){let r=n.projects.findIndex(n=>n.projno===i.projno);r<0&&(n.projects.push({logs:[],projno:i.projno,realHour:i.realHour}),r=n.projects.length-1);n.projects[r].logs.push({user:t.User,yymm:t.yymm,id:i.id,content:i.content,endDate:i.endDate,note:i.note})}for(let t of i){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[{}],projno:t.projno}),i=n.projects.length-1);n.projects[i].itemno?(n.projects[i].itemno+=`${t.itemno}, `,n.projects[i].workHour+=t.workHour,n.projects[i].overtime+=t.overtime):(n.projects[i].itemno=`${t.itemno}, `,n.projects[i].workHour=t.workHour,n.projects[i].overtime=t.overtime)}for(let t=0;t<n.projects.length;t++)(n.projects[t].workHour||n.projects[t].overtime)&&(n.projects[t].hourStr=n.projects[t].workHour.toString()+" + "+n.projects[t].overtime.toString()),n.projects[t].itemno&&(n.projects[t].itemno=n.projects[t].itemno.slice(0,n.projects[t].itemno.length-2));n.projectList.push({projects:n.projects})}}).catch(function(){alert("Error")})}]);app.controller("DetailsCtrl",["$scope","$window","appService","$rootScope","$q",function(n,t,i){i.GetUserByGuid({guid:t.guid}).then(t=>{n.user=t.data,document.title=n.user.name+"-工作紀錄管控表"});i.GetTasklogDataByGuid({guid:t.guid}).then(t=>{n.projects=[];const r=t.data.ProjectItems,i=t.data.ProjectTasks;n.yymm=i[0].yymm;for(let t of i){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[],projno:t.projno,realHour:t.realHour}),i=n.projects.length-1);n.projects[i].logs.push({id:t.id,content:t.content,endDate:t.endDate,note:t.note})}for(let t of r){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[{}],projno:t.projno}),i=n.projects.length-1);n.projects[i].itemno?(n.projects[i].itemno+=`${t.itemno}, `,n.projects[i].workHour+=t.workHour,n.projects[i].overtime+=t.overtime):(n.projects[i].itemno=`${t.itemno}, `,n.projects[i].workHour=t.workHour,n.projects[i].overtime=t.overtime)}for(let t=0;t<n.projects.length;t++)(n.projects[t].workHour||n.projects[t].overtime)&&(n.projects[t].hourStr=n.projects[t].workHour.toString()+" + "+n.projects[t].overtime.toString()),n.projects[t].itemno&&(n.projects[t].itemno=n.projects[t].itemno.slice(0,n.projects[t].itemno.length-2))})}]);app.controller("EditCtrl",["$scope","$window","appService","$rootScope","$q","$timeout",function(n,t,i,r,u,f){function c({target:n}){n.classList.contains("autoExpand")&&!0&&(n.style.height="",n.style.height=Math.min(n.scrollHeight,e)+"px")}n.months=["01","02","03","04","05","06","07","08","09","10","11","12"];n.years=[];n.ctrl={};n.ctrl.datepicker=moment().locale("zh-tw").format("YYYY-MM");const o=new Date,[s,h]=[o.getMonth(),o.getFullYear()];var e=250;for(let t=h;t!==2019;t--)n.years.push(t.toString());n.selectedYear=n.years[0];n.selectedMonth=n.months[s];n.data=[];n.deletedIds=[];n.projects=[{logs:[{}]}];n.addLogRow=t=>{n.projects[t].logs.splice(n.projects[t].logs.length,0,{})};n.removeLogRow=(t,i)=>{if(n.projects[t].itemno!==undefined&&n.projects[t].logs.length===1)n.projects[t].logs[i].content="",n.projects[t].logs[i].endDate="",n.projects[t].logs[i].note="";else{let r=n.projects[t].logs[i].id;r&&n.deletedIds.push(r);n.projects[t].logs.splice(i,1)}};n.addProjRow=()=>{n.projects.push({logs:[{}]})};n.UpdateTasklogData=()=>{let t=[],s=`${Number(n.ctrl.datepicker.slice(0,4))-1911}${n.ctrl.datepicker.slice(5,7)}`;for(var r of n.projects)for(let n of r.logs)t.push({id:n.id,yymm:s,projno:r.projno,realHour:r.realHour,content:n.content,endDate:n.endDate,note:n.note});let e=Promise.resolve("a"),o=Promise.resolve("b");n.deletedIds.length!==0&&(e=i.DeleteProjectTask(n.deletedIds).then(()=>{}).catch(()=>{alert("Error")}));t.length!==0&&(o=i.UpdateProjectTask(t).then(()=>{}).catch(()=>{alert("Error")}));u.all([e,o]).then(()=>{n.GetTasklogData(),n.succeed=!0,f(function(){n.succeed=!1},2e3)})};n.GetTasklogData=()=>{let t=`${Number(n.ctrl.datepicker.slice(0,4))-1911}${n.ctrl.datepicker.slice(5,7)}`;i.GetTasklogData({yymm:t}).then(t=>{n.projects=[];const i=t.data.ProjectItems,r=t.data.ProjectTasks;for(let t of r){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[],projno:t.projno,realHour:t.realHour}),i=n.projects.length-1);n.projects[i].logs.push({id:t.id,content:t.content,endDate:t.endDate,note:t.note})}for(let t of i){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[{}],projno:t.projno}),i=n.projects.length-1);n.projects[i].itemno?(n.projects[i].itemno+=`${t.itemno}, `,n.projects[i].workHour+=t.workHour,n.projects[i].overtime+=t.overtime):(n.projects[i].itemno=`${t.itemno}, `,n.projects[i].workHour=t.workHour,n.projects[i].overtime=t.overtime)}for(let t=0;t<n.projects.length;t++)(n.projects[t].workHour||n.projects[t].overtime)&&(n.projects[t].hourStr=n.projects[t].workHour.toString()+" + "+n.projects[t].overtime.toString(),n.projects[t].realHour||(n.projects[t].realHour=n.projects[t].workHour+n.projects[t].overtime)),n.projects[t].itemno&&(n.projects[t].itemno=n.projects[t].itemno.slice(0,n.projects[t].itemno.length-2));n.projects.length===0&&n.projects.push({logs:[{}]});f(function(){var t=document.querySelectorAll(".autoExpand");for(var n of t)n.style.height="",n.style.height=Math.min(n.scrollHeight,e)+"px"},0)})};n.GetTasklogData();n.GetLastMonthData=()=>{let t=`${Number(n.ctrl.datepicker.slice(0,4))-1911}${n.ctrl.datepicker.slice(5,7)}`;i.GetLastMonthData({yymm:t}).then(t=>{n.projects=[];const i=t.data.ProjectItems,r=t.data.ProjectTasks;for(let t of r){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[],projno:t.projno,realHour:t.realHour}),i=n.projects.length-1);n.projects[i].logs.push({id:t.id,content:t.content,endDate:t.endDate,note:t.note})}for(let t of i){let i=n.projects.findIndex(n=>n.projno===t.projno);i<0&&(n.projects.push({logs:[{}],projno:t.projno}),i=n.projects.length-1);n.projects[i].itemno?(n.projects[i].itemno+=`${t.itemno}, `,n.projects[i].workHour+=t.workHour,n.projects[i].overtime+=t.overtime):(n.projects[i].itemno=`${t.itemno}, `,n.projects[i].workHour=t.workHour,n.projects[i].overtime=t.overtime)}for(let t=0;t<n.projects.length;t++)(n.projects[t].workHour||n.projects[t].overtime)&&(n.projects[t].hourStr=n.projects[t].workHour.toString()+" + "+n.projects[t].overtime.toString(),n.projects[t].realHour||(n.projects[t].realHour=n.projects[t].workHour+n.projects[t].overtime)),n.projects[t].itemno&&(n.projects[t].itemno=n.projects[t].itemno.slice(0,n.projects[t].itemno.length-2));n.projects.length===0&&n.projects.push({logs:[{}]});f(function(){var t=document.querySelectorAll(".autoExpand");for(var n of t)n.style.height="",n.style.height=Math.min(n.scrollHeight,e)+"px"},0)})};n.GetLastMonthData();document.addEventListener("input",c)}]);